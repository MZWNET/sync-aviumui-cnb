name: Sync dodge vendor repos to CNB
on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync dodge vendor repos to CNB
        run: |
          snapshot_mirror() {
              local SOURCE_URL=$1
              local BRANCH=$2
              local TARGET_URL=$3
              local REPO_NAME=$(basename "$SOURCE_URL" .git)

              echo "正在处理: $REPO_NAME ($BRANCH)"

              git clone --branch "$BRANCH" --single-branch --depth 1 "$SOURCE_URL" "$REPO_NAME"
              cd "$REPO_NAME"

              TREE=$(git rev-parse HEAD^{tree})
              AUTHOR_NAME=$(git log -1 --pretty=format:'%an' HEAD)
              AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae' HEAD)
              AUTHOR_DATE=$(git log -1 --pretty=format:'%aI' HEAD)
              COMMITTER_NAME=$(git log -1 --pretty=format:'%cn' HEAD)
              COMMITTER_EMAIL=$(git log -1 --pretty=format:'%ce' HEAD)
              COMMITTER_DATE=$(git log -1 --pretty=format:'%cI' HEAD)
              COMMIT_MSG=$(git log -1 --pretty=format:'%B' HEAD)

              NEW_COMMIT=$(GIT_AUTHOR_NAME="$AUTHOR_NAME" \
                  GIT_AUTHOR_EMAIL="$AUTHOR_EMAIL" \
                  GIT_AUTHOR_DATE="$AUTHOR_DATE" \
                  GIT_COMMITTER_NAME="$COMMITTER_NAME" \
                  GIT_COMMITTER_EMAIL="$COMMITTER_EMAIL" \
                  GIT_COMMITTER_DATE="$COMMITTER_DATE" \
                  git commit-tree $TREE -m "$COMMIT_MSG")

              git checkout -B "$BRANCH" "$NEW_COMMIT"

              git for-each-ref --format='%(refname)' refs/remotes refs/heads | \
                  grep -v "refs/heads/$BRANCH" | xargs -r -n1 git update-ref -d

              git remote remove origin
              git remote add target "$TARGET_URL"
              git push target "$BRANCH" --force
              git lfs push target "$BRANCH" 2>/dev/null || true

              cd ..
              echo "完成: $REPO_NAME"
              rm -rf "$REPO_NAME"
              echo "---"
          }

          git lfs install
          git config --global lfs.locksverify true

          snapshot_mirror \
            "https://github.com/TheMuppets/proprietary_vendor_oneplus_dodge" \
            "lineage-23.2" \
            "https://cnb:${{ secrets.CNB_TOKEN }}@cnb.cool/MZWNET/TheMuppets/proprietary_vendor_oneplus_dodge"

          snapshot_mirror \
            "https://github.com/TheMuppets/proprietary_vendor_oneplus_sm8750-common" \
            "lineage-23.2" \
            "https://cnb:${{ secrets.CNB_TOKEN }}@cnb.cool/MZWNET/TheMuppets/proprietary_vendor_oneplus_sm8750-common"
